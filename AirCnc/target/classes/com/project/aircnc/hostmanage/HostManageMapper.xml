<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.aircnc.hostmanage.HostManageMapper">
	
	<select id="selUserReserCc" parameterType="TUserVO" resultType="int">
		SELECT COUNT(i_reser) 
		FROM user_reser
		WHERE i_host IN(
			SELECT i_host
			FROM host_user
			WHERE i_user = #{i_user}
		)
		AND reser_state IN('ch','cc')
	</select>
	
	<select id="selUserReser" parameterType="TUserVO" resultType="int">
		
		SELECT COUNT(i_reser) 
		FROM user_reser
		WHERE i_host IN(
			SELECT i_host
			FROM host_user
			WHERE i_user = #{i_user}
		)
		AND ISNULL(reser_state) 
	</select>
	
	<select id="selRsv" parameterType="TUserVO" resultType="RsvVO">
		SELECT a.i_reser, a.i_host, a.i_user,a.check_in AS chin,a.check_out AS chout,
		a.gest_qty AS qty , a.total_fee,a.reser_state, 
		b.img_url, c.ROOM_TITLE,c.addr,DATE_FORMAT(a.R_DT,'%Y-%m-%d') AS R_DT, DATE_FORMAT(a.m_dt,'%Y-%m-%d') AS M_DT
		FROM user_reser a
		INNER JOIN (
		SELECT *
		FROM rooms_img
		GROUP BY i_host
		) b
		ON a.i_host = b.i_host
		INNER JOIN host_user c
		ON a.i_host = c.I_HOST
		WHERE c.I_USER = ${i_user}
		AND a.check_out >= DATE_FORMAT(NOW(),'%Y-%m-%d')
		AND  ISNULL(a.reser_state)
		ORDER BY a.R_DT DESC
	</select>
	
	<select id="selViewData" parameterType="int" resultType="RsvViewData">
		SELECT a.i_reser, a.i_host, a.i_user,a.check_in AS chin,a.check_out AS chout,
		a.gest_qty AS qty , a.total_fee,
		c.img_url, d.ROOM_TITLE, DATE_FORMAT(a.R_DT,'%Y-%m-%d') AS R_DT, DATE_FORMAT(a.m_dt,'%Y-%m-%d') AS M_DT,
		d.BED_QTY, b.NM, b.PRO_IMG,e.live_type,e.typ,f.fee
		FROM user_reser a
		INNER JOIN t_user b
		ON a.I_USER = b.I_USER
		INNER JOIN (
		SELECT *
		FROM rooms_img
		GROUP BY i_host
		) c
		ON a.i_host = c.i_host
		INNER JOIN host_user d
		ON a.i_host = d.i_host
		INNER JOIN build_type e
		ON a.i_host= e.i_host
		INNER JOIN room_fee f
		ON a.I_HOST = f.i_host
		WHERE a.I_RESER = #{i_reser};
		
	</select>
	
	<select id="selCompleteData" parameterType="TUserVO" resultType="RsvVO">
		SELECT a.i_reser, a.i_host, a.i_user,a.check_in AS chin,a.check_out AS chout,
		a.gest_qty AS qty , a.total_fee,a.reser_state, 
		b.img_url, c.ROOM_TITLE,c.addr,DATE_FORMAT(a.R_DT,'%Y-%m-%d') AS R_DT, DATE_FORMAT(a.m_dt,'%Y-%m-%d') AS M_DT
		FROM user_reser a
		INNER JOIN (
		SELECT *
		FROM rooms_img
		GROUP BY i_host
		) b
		ON a.i_host = b.i_host
		INNER JOIN host_user c
		ON a.i_host = c.I_HOST
		WHERE c.I_USER = #{i_user}
		<![CDATA[
		AND a.check_out < DATE_FORMAT(NOW(),'%Y-%m-%d')
		]]>
		AND  ISNULL(a.reser_state)
		ORDER BY a.R_DT DESC
		
	</select>
	
	<select id="selCancelData" parameterType="TUserVO" resultType="HostRsvCancelVO">
		SELECT b.I_CANCEL, a.i_host, b.I_USER,d.nm, b.REASON, c.img_url,d.PRO_IMG,
		a.ROOM_TITLE,
		DATE_FORMAT(b.R_DT,'%Y-%m-%d') AS R_DT, DATE_FORMAT(b.m_dt,'%Y-%m-%d') AS M_DT
		FROM host_user a
		INNER JOIN user_rsv_cancel b
		ON a.I_HOST = b.i_host
		INNER JOIN (
		SELECT *
		FROM rooms_img
		GROUP BY i_host
		) c
		ON a.i_host = c.i_host
		INNER JOIN t_user d
		ON b.i_user = d.I_USER
		WHERE a.I_USER = ${i_user}
		AND b.STATE = 'o';
	</select>
	
	<select id="selrsvCcData" parameterType="TUserVO" resultType="RsvVO">
		SELECT a.i_reser, a.i_host, a.i_user,a.check_in AS chin,a.check_out AS chout,
		a.gest_qty AS qty , a.total_fee,a.reser_state, 
		b.img_url, c.ROOM_TITLE,c.addr,DATE_FORMAT(a.R_DT,'%Y-%m-%d') AS R_DT, DATE_FORMAT(a.m_dt,'%Y-%m-%d') AS M_DT
		FROM user_reser a
		INNER JOIN (
		SELECT *
		FROM rooms_img
		GROUP BY i_host
		) b
		ON a.i_host = b.i_host
		INNER JOIN host_user c
		ON a.i_host = c.I_HOST
		WHERE c.I_USER = #{i_user}
		AND a.reser_state IN('cc','ch')
		ORDER BY a.R_DT asc
	</select>
	
	<select id="selAllViewData" parameterType="TUserVO" resultType="RsvVO">
		SELECT a.i_reser, a.i_host, a.i_user,a.check_in AS chin,a.check_out AS chout,
		a.gest_qty AS qty , a.total_fee,
		<![CDATA[
		IF(a.reser_state IS NOT null ,a.reser_state, if(a.check_out < DATE_FORMAT(NOW(),'%Y-%m-%d'),'complete',a.reser_state)) AS reser_state, 
		b.img_url, c.ROOM_TITLE,c.addr,DATE_FORMAT(a.R_DT,'%Y-%m-%d') AS R_DT, DATE_FORMAT(a.m_dt,'%Y-%m-%d') AS M_DT
		]]>
		FROM user_reser a
		INNER JOIN (
		SELECT *
		FROM rooms_img
		GROUP BY i_host
		) b
		ON a.i_host = b.i_host
		INNER JOIN host_user c
		ON a.i_host = c.I_HOST
		WHERE c.I_USER = #{i_user}
		ORDER BY a.R_DT asc
	</select>
	
	<select id="selChangeData" parameterType="UserRsvChangeVO" resultType="SelChangeDataVO">
		SELECT b.i_host,b.I_USER,b.I_RESER,b.I_CHANGE,
		b.CHIN, b.CHOUT, b.GEST_QTY, b.TOTAL_FEE,
		b.BE_CHIN,b.BE_CHOUT,b.BE_GEST_QTY, b.BE_TOTAL_FEE,
		c.img_url, d.ROOM_TITLE,d.addr,DATE_FORMAT(a.R_DT,'%Y-%m-%d') AS R_DT, DATE_FORMAT(a.m_dt,'%Y-%m-%d') AS M_DT,
		a.RESER_STATE AS state, d.BED_QTY,e.live_type, e.typ, f.NM, f.PRO_IMG
		FROM user_reser a
		INNER JOIN user_rsv_change b
		ON a.I_RESER = b.i_reser
		INNER JOIN (
		SELECT *
		FROM rooms_img
		GROUP BY i_host
		) c
		ON a.i_host = c.i_host
		INNER JOIN host_user d
		ON a.i_host = d.I_HOST
		INNER JOIN build_type e
		ON a.i_host = e.I_HOST
		INNER JOIN t_user f
		ON a.i_user = f.i_user
		WHERE a.i_reser = #{i_reser}
		AND a.RESER_STATE = 'ch'
	</select>
	
	<select id="selCcelReason" parameterType="UserRsvCancelVO" resultType="UserRsvCancelVO">
		SELECT *
		FROM user_rsv_cancel
		WHERE state IS NULL
		AND i_reser = #{i_reser}
	</select>
	
	<update id="upRsvChange" parameterType="UserRsvChangeVO">
		UPDATE user_reser a
		INNER JOIN user_rsv_change b
		ON a.I_RESER = b.I_RESER
		SET a.reser_state = NULL,
		a.check_in	= b.BE_CHIN,
		a.check_out = b.BE_CHOUT,
		a.GEST_QTY 	= b.BE_GEST_QTY,
		a.total_FEE	= b.BE_TOTAL_FEE
		WHERE a.i_reser = #{i_reser}
		AND a.reser_state = 'ch';
		
		UPDATE host_user a
		INNER JOIN user_rsv_change b
		ON a.i_host = b.i_host
		SET a.RV_STATE = (a.RV_STATE-b.gest_qty)+ b.BE_GEST_QTY 
		WHERE b.i_reser = #{i_reser}
		AND b.STATE IS NULL;

		UPDATE user_rsv_change
		SET state = 'o'
		WHERE i_reser = #{i_reser}
		AND state IS NULL;
	</update>
	
	<select id="existGestQty" parameterType="UserRsvChangeVO" resultType="int">
		SELECT EXISTS(
			SELECT  *
			FROM host_user a
			INNER JOIN user_rsv_change b
			ON a.i_host = b.i_host
			WHERE b.i_reser = #{i_reser}
			AND a.R_VASTION >= (a.RV_STATE-b.gest_qty)+ b.BE_GEST_QTY 
			AND b.STATE IS NULL
		);
	</select>
	
	<delete id="RsvCancel" parameterType="UserRsvCancelVO">
		DELETE FROM aircnc_msg 
		WHERE i_reser = #{i_reser};
		
		DELETE a
		FROM aircnc_msgusers a
		INNER JOIN aircnc_msglist b
		ON a.i_mlist = b.i_mlist
		WHERE b.I_RESER = #{i_reser};
		
		DELETE FROM aircnc_msglist
		WHERE i_reser = #{i_reser};
		
	</delete>
	
	<update id="upRsvCancel" parameterType="UserRsvCancelVO">
		UPDATE host_user a
		INNER JOIN user_reser b
		ON a.I_HOST = b.I_HOST
		SET a.RV_STATE = a.RV_STATE - b.GEST_QTY
		WHERE b.RESER_STATE = 'cc' 
		AND b.i_reser  = #{i_reser};
		
		UPDATE user_rsv_cancel
		SET state = 'o'
		WHERE state IS NULL
		AND i_reser  = #{i_reser};
	</update>
	
	<delete id="delRsvCancel" parameterType="UserRsvCancelVO">
		DELETE FROM USER_RESER
		WHERE i_reser = #{i_reser};
	</delete>

</mapper>